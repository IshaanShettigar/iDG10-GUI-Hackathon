<html>

<head>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.6.2/joint.css" />
    <link rel="stylesheet" href="twopaper.css" />
</head>

<body>
    <div id="toolbar" style="display: inline-block; "></div>
    <div id="main" style="display: inline-block; "></div>
    <a id="logo-link" href="https://www.idg10.com/home">
        <image class="logo" src="company-logo.PNG" width="100" height="50"></image>
    </a>
    <label><input type="button" class="save" id="save" value="Save"></label>
    <label><input type="file" class="open" id="open" name="filename"></label>


    <!---dependencies-->
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <script src="node_modules/lodash/lodash.js"></script>
    <script src="node_modules/backbone/backbone.js"></script>
    <script src="node_modules/jointjs/dist/joint.js"></script>

    <script type="text/javascript">

        var namespace = joint.shapes
        var mainGraph = new joint.dia.Graph({}, { cellNamespace: namespace });

        var mainPaper = new joint.dia.Paper({
            el: document.getElementById('main'),
            model: mainGraph,
            width: 1000,
            height: 800,
            gridSize: 15,
            drawGrid: { name: "mesh" },
            background: {
                color: "#F3F7F6"
            },
            cellViewNamespace: namespace,
            interactive: {
                linkMove: true,
                labelMove: true,
                arrowheadMove: true,
                vertexMove: true,
                vertexAdd: true,
                vertexRemove: true,
                useLinkTools: true
            },
            snapLabels: true,
            gridSize: 8
        });

        // create shapes for toolbar
        /*var rect1 = new joint.shapes.standard.Rectangle();
        rect1.resize(100, 100);
        rect1.position(10, 10);
        rect1.attr({
            body: {
                fill: 'white',
                stroke: 'black',
                strokeWidth: 2
            },
            label: {
                text: 'Rect1',
                fill: 'black'
            }
        })

        var circle1 = new joint.shapes.standard.Circle()
        circle1.resize(100, 100);
        circle1.position(10, 150);
        circle1.attr({
            body: {
                fill: 'white'
            },
            label: {
                text: 'Circle1',
                fill: 'black'
            }
        })

        var cylinder1 = new joint.shapes.standard.Cylinder()
        cylinder1.resize(100, 100);
        cylinder1.position(10, 290);
        cylinder1.attr({
            body: {
                fill: 'white',
                stroke: 'black',
                strokeWidth: 2
            },
            label: {
                text: 'Cylinder1',
                fill: 'black'
            }
        })*/

        function getInput(evt, linkView, buttonView) {
            // Create a new input element
            // const input = document.createElement('input');
            var newText = prompt("Enter new label text")
            var theLink = linkView.model
            theLink.appendLabel({
                attrs: {
                    text: {
                        text: newText
                    }
                },
                position: {
                    distance: 0.25,
                    offset: -25

                },
            });

        }



        // create links for toolbar
        var standardLink = new joint.shapes.standard.Link()
        standardLink.source({ x: 45, y: 600 })
        standardLink.target({ x: 125, y: 550 })
        var verticesTool = new joint.linkTools.Vertices();
        var segmentsTool = new joint.linkTools.Segments();
        var boundaryTool = new joint.linkTools.Boundary();
        var sourceAnchorTool = new joint.linkTools.SourceAnchor();
        var targetAnchorTool = new joint.linkTools.TargetAnchor();
        var sourceArrowHeadTool = new joint.linkTools.SourceArrowhead();
        var targetArrowHeadTool = new joint.linkTools.TargetArrowhead();
        var removeButton = new joint.linkTools.Remove();
        joint.linkTools.InfoButton = joint.linkTools.Button.extend({
            name: 'info-button',
            options: {
                markup: [{
                    tagName: 'circle',
                    selector: 'button',
                    attributes: {
                        'r': 7,
                        'fill': 'mediumseagreen',
                        'cursor': 'pointer'
                    }
                }, {
                    tagName: 'path',
                    selector: 'icon',
                    attributes: {
                        'd': 'M 0 0 0 0 M 0 5 0 0 M -1 -1 1 -1 M 0 0 0 -4.5 M -4 0 0 0 M 4.5 0 0 0 ',
                        'fill': 'none',
                        'stroke': '#FFFFFF',
                        'stroke-width': 2,
                        'pointer-events': 'none'
                    }
                }],
                distance: "50%",
                offset: 0,
                action: function (evt, linkView, buttonView) {
                    getInput(evt, linkView, buttonView);
                }
            }
        });

        var infoButton = new joint.linkTools.InfoButton();





        var toolsView = new joint.dia.ToolsView({
            tools: [verticesTool, segmentsTool, boundaryTool, sourceArrowHeadTool, targetArrowHeadTool, removeButton, infoButton]
        })


        var doubleLink = new joint.shapes.standard.DoubleLink();
        doubleLink.source({ x: 45, y: 700 });
        doubleLink.target({ x: 125, y: 650 });
        doubleLink.attr('root/tabindex', 15);
        doubleLink.attr('root/title', 'joint.shapes.standard.DoubleLink');
        doubleLink.attr('line/stroke', '#30d0c6');



        var toolGraph = new joint.dia.Graph({}, { cellNamespace: namespace });
        var toolPaper = new joint.dia.Paper({
            el: document.getElementById('toolbar'),
            model: toolGraph,
            width: 200,
            height: 800,
            gridSize: 10,
            drawGrid: true,
            background: {
                color: "rgba(255,255,0,0.3)"
            },
            snapLabels: true,
            gridSize: 5,
            interactive: false
        });

        // rect1.addTo(toolGraph)
        // circle1.addTo(toolGraph)
        // cylinder1.addTo(toolGraph)
        standardLink.addTo(toolGraph)
        doubleLink.addTo(toolGraph);

        var svgMarkup1 = '<g>' +
            '<rect id="svgEditorBackground" x="0" y="0" width="em" height="em" style="fill: none; stroke: none;" />' +
            '<g style="fill:rosybrown;stroke:black;vector-effect:non-scaling-stroke;stroke-width:1px" id="e1_shape" transform="matrix(2.68046 0 0 2.68046 668.263 180.039)" />' +
            '<rect x="113.67" y="62.96" style="fill:gold;stroke:black;stroke-width:1px" id="e2_rectangle" width="155.37" height="58.14" transform="matrix(0.753349 0 0 0.993163 25.5479 0.361935)" />' +
            '<path d="M77.123285,77.597995h34.085175" style="fill:red;stroke:red;stroke-width:3px" id="e4_pathH" />' +
            '<path d="M77.123285,92.634009h34.085175" style="fill:blue;stroke:blue;stroke-width:3px" id="e2_pathH" />' +
            '<path d="M77.123285,108.672424h34.085175" style="fill:mediumseagreen;stroke:mediumseagreen;stroke-width:3px" id="e3_pathH" />' +
            '<path d="M228.485823,85.617203h34.085175" style="fill:red;stroke:red;stroke-width:3px" id="e5_pathH" />' +
            '<path d="M228.485822,102.658018h34.085175" style="fill:blue;stroke:blue;stroke-width:3px" id="e6_pathH" />' +
            '</g>';

        // Define the custom JointJS element
        var myElement1 = joint.shapes.basic.Generic.extend({

            // Set the element's markup to the SVG code
            markup: svgMarkup1,

            // Set the default attributes for the element
            defaults: joint.util.deepSupplement({
                type: 'myElement1',
                size: {
                    width: "em",
                    height: "em"
                },
                attrs: {
                    rect: {
                        'pointer-events': 'boundingBox'
                    },
                    path: {
                        'pointer-events': 'none'
                    }
                }
            }, joint.shapes.basic.Generic.prototype.defaults)
        });

        // Register the element with the graph
        joint.shapes.myElement1 = myElement1;

        // Create a new instance of the element
        var myElementInstance1 = new joint.shapes.myElement1({
            position: { x: -70, y: 1 }
        });
        myElementInstance1.resize(50, 50);
        // Add the element to the graph
        toolGraph.addCell(myElementInstance1);



        var svgMarkup2 = '<g>' +
            '<rect id="svgEditorBackground" x="0" y="0" width="em" height="em" style = "fill: none; stroke: none;" /> ' +
            '<rect x = "372.2061111014" y = "208.730" style = "fill:royalblue;stroke:black;stroke-width:1px" id = "e1_rectangle" width = "83.731" height = "75.7570029623" />' +
            '<line id="e2_line" x1="454.9407327576" y1="208.730" x2="477.8671941803" y2="188.7944273242" style="stroke:black;fill:none;stroke-width:2px" />' +
            '<line id="e3_line" x1="350.277000" y1="303.426000" x2="373.203000" y2="283.491000" style="stroke:black;fill:none;stroke-width:2px" />' +
            '<line id="e4_line" x1="455.936" y1="284.488" x2="475.873" y2="304.431" style="stroke:black;fill:none;stroke-width:2px" />' +
            '<line id="e5_line" x1="349.279" y1="189.793" x2="372.207000" y2="209.736000" style="stroke:black;fill:none;stroke-width:2px" />' +
            '</g>';

        var myElement2 = joint.shapes.basic.Generic.extend({

            // Set the element's markup to the SVG code
            markup: svgMarkup2,

            // Set the default attributes for the element
            defaults: joint.util.deepSupplement({
                type: 'myElement2',
                size: {
                    width: "em",
                    height: "em"
                },
                attrs: {
                    rect: {
                        'pointer-events': 'boundingBox'
                    },
                    path: {
                        'pointer-events': 'none'
                    }
                }
            }, joint.shapes.basic.Generic.prototype.defaults)
        });

        // Register the element with the graph
        joint.shapes.myElement2 = myElement2;

        // Create a new instance of the element
        var myElementInstance2 = new joint.shapes.myElement2({
            position: { x: -315, y: 1 }
        });
        myElementInstance2.resize(50, 50)
        // Add the element to the graph
        toolGraph.addCell(myElementInstance2);


        var svgMarkup3 = '<g>' +
            '<rect id="svgEditorBackground" x="0" y="0" width="em" height="em" style="fill: none; stroke: none;" />' +
            '<rect x="410.2436949299" y="207.3210141809" style="fill:cornflowerblue;stroke:black;stroke-width:1px" id="e1_rectangle" width="126.956" height="29.9892" />' +
            '<rect x="421.24" y="183.332" style="fill:gold;stroke:black;stroke-width:1px" id="e2_rectangle" width="57.9778" height="23.9912" />' +
            '<rect x="428.236839712" y="238.3092079722" style="fill:none;stroke:black;stroke-width:1px" id="e4_rectangle" width="22.9918" height="19.992" />' +
            '<rect x="499.210000" y="237.310000" style="fill:none;stroke:black;stroke-width:1px" id="e3_rectangle" width="22.991800" height="19.992000" />' +
            '<line id="e5_line" x1="438.2330312576" y1="238.3092079722" x2="438.233" y2="270.294" style="stroke:mediumseagreen;fill:none;stroke-width:3px" />' +
            '<line id="e2_line" x1="507.207" y1="237.309" x2="507.207" y2="271.294" style="stroke:red;fill:none;stroke-width:3px" />' +
            '<line id="e3_line" x1="516.204000" y1="237.309000" x2="516.204" y2="271.293" style="stroke:blue;fill:none;stroke-width:3px" />' +
            '<polygon style="stroke:black;fill:gold;stroke-width:1px" id="e7_polygon" points="431.235 183.33 436.234 119.354 445.23 119.355 448.229 183.33" />' +
            '<polygon style="stroke:black;fill:none;stroke-width:1px" id="e8_polygon" points="472.22,181.331,532.197,139.347,536.196,147.344,481.217,189.328" />' +
            '<line id="e4_line" x1="532.198000" y1="144.344000" x2="532.198000" y2="185.329000" style="stroke:black;fill:none;stroke-width:2px" />' +
            '</g>';

        var myElement3 = joint.shapes.basic.Generic.extend({

            // Set the element's markup to the SVG code
            markup: svgMarkup3,

            // Set the default attributes for the element
            defaults: joint.util.deepSupplement({
                type: 'myElement3',
                size: {
                    width: "50",
                    height: "50"
                },
                attrs: {
                    rect: {
                        'pointer-events': 'boundingBox'
                    },
                    path: {
                        'pointer-events': 'none'
                    },
                    line: {
                        'pointer-events': 'boundingBox'
                    }
                }
            }, joint.shapes.basic.Generic.prototype.defaults)
        });

        // Register the element with the graph
        joint.shapes.myElement3 = myElement3;

        // Create a new instance of the element
        var myElementInstance3 = new joint.shapes.myElement3({
            position: { x: -380, y: 240 }
        });
        myElementInstance3.resize(50, 50)
        // Add the element to the graph
        toolGraph.addCell(myElementInstance3);


        const ResizeTool = joint.elementTools.Control.extend({
            children: [
                {
                    tagName: "image",
                    selector: "handle",
                    attributes: {
                        cursor: "pointer",
                        width: 20,
                        height: 20,
                        "xlink:href":
                            "https://assets.codepen.io/7589991/8725981_image_resize_square_icon.svg"
                    }
                },
                {
                    tagName: "rect",
                    selector: "extras",
                    attributes: {

                        fill: "none",
                        stroke: "#33334F",
                        "stroke-dasharray": "2,4",
                        rx: 5,
                        ry: 5
                    }
                }
            ],
            getPosition: function (view) {
                const model = view.model;
                const { width, height } = model.size();
                return { x: width, y: height };
            },
            setPosition: function (view, coordinates) {
                const model = view.model;
                model.resize(
                    Math.max(coordinates.x - 10, 1),
                    Math.max(coordinates.y - 10, 1)
                );
            }
        });



        // rectView.addTools(resizeToolView)



        // now let us add some event listeners
        toolPaper.on('element:pointerdblclick', function (elementView) {
            var currentEle = elementView.model;
            var newEle = currentEle.clone()
            // newEle.resize(100, 100);
            newEle.position(200, 200)
            newEle.addTo(mainGraph)
            // var eleBbox = currentEle.getBBox()
            // var removeButton = new joint.elementTools.Remove({
            //     useModelGeometry: true,
            //     // offset: { x: eleBbox.width * 0.5, y: eleBbox.height }
            // });
            // var EletoolsView = new joint.dia.ToolsView({
            //     tools: [removeButton, new ResizeTool({ selector: 'body' })]
            // });

            // newEleView = newEle.findView(mainPaper);
            // newEleView.addTools(EletoolsView);
            // newEleView.hideTools();
        })

        toolPaper.on('link:pointerdblclick', function (linkView) {
            var currentLink = linkView.model;
            var newLink = currentLink.clone()


            newLink.source({ x: 500, y: 500 })
            newLink.target({ x: 580, y: 450 })
            newLink.addTo(mainGraph)
        })

        var mask = joint.highlighters.mask;

        var selectedCellView = null;
        mainPaper.on('element:pointerclick', function (cellView) {
            // remove highlights for all other elements
            mainGraph.getCells().forEach(function (cell) {
                mask.remove(cell.findView(mainPaper));
            });
            selectedCellView = cellView;

            //add highlight for this element
            mask.remove(cellView);
            console.log(selectedCellView)
            mask.add(cellView, 'root', 'element-highlight', {
                deep: true,
                attrs: {
                    'stroke': '#FF4365',
                    'stroke-width': 3
                }
            });
        })

        // var createCopy = null;
        // var copiedCoordinates = null;

        // // copy
        // document.addEventListener('keydown', function (event) {
        //     if (event.keyCode === 67 && event.ctrlKey) {

        //         if (selectedCellView != null) {
        //             // Ctrl+C was pressed
        //             console.log('Ctrl+C was pressed');
        //             console.log(`Cellview to be copied is ${JSON.stringify(selectedCellView.model)
        //                 }`)
        //             // selectedElementView
        //             createCopy = selectedCellView.model.clone();

        //             copiedCoordinates = selectedCellView.getBBox()
        //             console.log(`Coordinates where copy occurred is ${copiedCoordinates}`);
        //         }
        //         else {
        //             alert("You have not selected an element to copy");
        //         }
        //     }
        // });

        // // paste
        // document.addEventListener('keydown', function (event) {
        //     if (event.keyCode === 86 && event.ctrlKey) {
        //         if (createCopy != null) {
        //             createCopy.position(copiedCoordinates.x + 20, copiedCoordinates.y + 20)


        //             var removeButton = new joint.elementTools.Remove({
        //                 useModelGeometry: true,
        //                 // offset: { x: eleBbox.width * 0.5, y: eleBbox.height }
        //             });
        //             var EletoolsView = new joint.dia.ToolsView({
        //                 tools: [removeButton, new ResizeTool({ selector: 'body' })]
        //             });


        //             createCopy.addTo(mainGraph);
        //             console.log("pasted element to mainGraph")
        //             var copyView = createCopy.findView(mainPaper);
        //             copyView.addTools(EletoolsView);
        //             copyView.hideTools();
        //             createCopy = null;
        //             copiedCoordinates = null;
        //         }
        //         else {
        //             alert("There is nothing to paste, clipboard empty!")
        //         }
        //     }
        // })

        // delete
        document.addEventListener('keydown', function (event) {
            if (event.keyCode === 46 && event.key === 'Delete') {
                if (selectedCellView != null) {
                    var theModel = selectedCellView.model
                    theModel.remove()
                    // this removes the attached links as well
                }
                else {
                    alert("You have not selected an element, Nothing to delete")
                }
            }
        })


        mainPaper.on('blank:pointerclick', function () {
            // Remove all Highlighters from all cells
            mainGraph.getCells().forEach(function (cell) {
                mask.remove(cell.findView(mainPaper));
            });
            selectedCellView = null;
        });


        mainPaper.on("link:mouseenter", function (linkView) {
            linkView.addTools(toolsView);
        })

        mainPaper.on("link:mouseleave", function (linkView) {
            linkView.removeTools(toolsView);
        })

        mainPaper.on("element:mouseenter", function (eleView) {
            eleView.showTools();
        })

        mainPaper.on("element:mouseleave", function (eleView) {
            eleView.hideTools();
        })

        // var sampleJSON = {"cells":[{"type":"standard.Rectangle","position":{"x":432,"y":200},"size":{"width":132,"height":31},"angle":0,"id":"1c23e9de-eca0-4216-8790-f8614d64921a","z":1,"attrs":{"body":{"stroke":"black","fill":"white"},"label":{"fill":"black","text":"Rect1"}}},{"type":"standard.Circle","position":{"x":616,"y":408},"size":{"width":100,"height":100},"angle":0,"id":"ea1fac67-323f-4820-aae5-6e4443535a14","z":2,"attrs":{"body":{"fill":"white"},"label":{"fill":"black","text":"Circle1"}}},{"type":"standard.Circle","position":{"x":272,"y":344},"size":{"width":100,"height":100},"angle":0,"id":"aba7eca8-6a01-4336-b23c-7eb4477c9c70","z":2,"attrs":{"body":{"fill":"white"},"label":{"fill":"black","text":"Circle1"}}},{"type":"standard.Cylinder","position":{"x":704,"y":176},"size":{"width":100,"height":100},"angle":0,"id":"9d808706-17f0-457f-b7e3-26ead7af5e3f","z":3,"attrs":{"body":{"fill":"white","stroke":"black"},"label":{"fill":"black","text":"Cylinder1"}}},{"type":"standard.Link","source":{"id":"aba7eca8-6a01-4336-b23c-7eb4477c9c70"},"target":{"id":"9d808706-17f0-457f-b7e3-26ead7af5e3f"},"id":"a861d443-e17b-4732-84d2-42d5a44b1539","z":4,"attrs":{}},{"type":"standard.Link","source":{"id":"aba7eca8-6a01-4336-b23c-7eb4477c9c70"},"target":{"id":"ea1fac67-323f-4820-aae5-6e4443535a14"},"id":"5aef323f-d763-4dd6-9ca4-b5a4b672e059","z":4,"attrs":{}},{"type":"standard.Link","source":{"id":"9d808706-17f0-457f-b7e3-26ead7af5e3f"},"target":{"id":"ea1fac67-323f-4820-aae5-6e4443535a14"},"id":"e3f13c28-6430-479e-b2e5-36b64ca4d468","z":4,"vertices":[{"x":536,"y":128},{"x":240,"y":128},{"x":240,"y":552},{"x":666,"y":552}],"attrs":{}},{"type":"standard.DoubleLink","source":{"id":"1c23e9de-eca0-4216-8790-f8614d64921a"},"target":{"id":"9d808706-17f0-457f-b7e3-26ead7af5e3f"},"id":"6ae31f60-ec60-46cb-85a7-fe514eccbf5d","z":5,"attrs":{"line":{"stroke":"#30d0c6"},"root":{"tabindex":15,"title":"joint.shapes.standard.DoubleLink"}}}]}
        // listen for the save button being clicked


        function downloadObjectAsJson(exportObj, exportName) {
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // save
        var saveButton = document.getElementById('save');
        saveButton.addEventListener('click', function () {
            var graphjson = mainGraph.toJSON()
            console.log(`Saving the following JSON \n\n${JSON.stringify(graphjson)}`);
            // mainGraph.fromJSON(sampleJSON)

            const name = prompt("Enter filename")
            if (name != null) {
                downloadObjectAsJson(graphjson, name)
                console.log("Saved it")
            }
            else {
                console.log("Cancelled saving")
            }
        })

        // open file
        var fileInput = document.getElementById('open')

        fileInput.addEventListener('change', function (event) {
            var file = event.target.files[0];
            console.log(`file ${file}`)
            // Create a new FileReader object
            var reader = new FileReader();
            // Add an event listener to the FileReader object
            reader.addEventListener('load', function () {

                // Parse the file contents as JSON
                var fileContents = JSON.parse(reader.result);
                // Log the parsed JSON to the console
                console.log(fileContents);
                mainGraph.fromJSON(fileContents);
            });
            // Read the selected file as text
            reader.readAsText(file);
        })
    </script>



</body>

</html>